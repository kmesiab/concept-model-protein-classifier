name: Deploy to ECS

on:
  workflow_run:
    workflows: ["Build and Push Docker Image"]
    types:
      - completed
    branches:
      - main
  workflow_dispatch:
    inputs:
      image_tag:
        description: 'Docker image tag to deploy (e.g., 3fcf35c or main-3fcf35c). If not provided, uses current commit SHA.'
        required: false
        type: string

permissions:
  id-token: write
  contents: read

env:
  AWS_REGION: us-west-2
  AWS_ACCOUNT_ID: ${{ vars.AWS_ACCOUNT_ID || '462498369025' }}
  ECS_CLUSTER: protein-classifier-api-1-0-0-prod-cluster
  ECS_SERVICE: protein-classifier-api-service
  ECR_REPOSITORY: protein-classifier-api
  CONTAINER_NAME: protein-classifier-api

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Configure AWS credentials via OIDC
        uses: aws-actions/configure-aws-credentials@v5
        with:
          role-to-assume: arn:aws:iam::${{ env.AWS_ACCOUNT_ID }}:role/github-actions-terraform
          role-session-name: github-actions-ecs-deploy
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Get current task definition
        id: current-task-def
        run: |
          if ! aws ecs describe-task-definition \
            --task-definition protein-classifier-api \
            --query 'taskDefinition' \
            --output json > task-definition.json 2>/dev/null; then
            echo "ERROR: Failed to retrieve ECS task definition 'protein-classifier-api'."
            echo "Ensure the Terraform infrastructure has been applied before running this workflow."
            echo "Run 'terraform apply' in the terraform/ directory to create the infrastructure."
            exit 1
          fi

      - name: Get image tag from commit SHA
        id: image-tag
        run: |
          # Use manual input if provided, otherwise use commit SHA from workflow run or current commit
          if [ -n "${{ inputs.image_tag }}" ]; then
            SHORT_SHA="${{ inputs.image_tag }}"
            echo "Using manually provided image tag: ${SHORT_SHA}"
          else
            COMMIT_SHA="${{ github.event.workflow_run.head_sha || github.sha }}"
            SHORT_SHA=$(echo "${COMMIT_SHA}" | cut -c1-7)
            echo "Using commit SHA: ${SHORT_SHA}"
          fi
          IMAGE_TAG="${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}:${SHORT_SHA}"
          echo "image_tag=${IMAGE_TAG}" >> $GITHUB_OUTPUT
          echo "short_sha=${SHORT_SHA}" >> $GITHUB_OUTPUT
          echo "Image tag to deploy: ${IMAGE_TAG}"

      - name: Verify image exists in ECR
        run: |
          echo "Verifying image exists in ECR..."
          if aws ecr describe-images \
            --repository-name ${{ env.ECR_REPOSITORY }} \
            --image-ids imageTag=${{ steps.image-tag.outputs.short_sha }} \
            --region ${{ env.AWS_REGION }} > /dev/null 2>&1; then
            echo "✅ Image tag ${{ steps.image-tag.outputs.short_sha }} exists in ECR"
          else
            echo "❌ ERROR: Image tag ${{ steps.image-tag.outputs.short_sha }} does not exist in ECR repository ${{ env.ECR_REPOSITORY }}"
            echo "Available tags:"
            aws ecr list-images --repository-name ${{ env.ECR_REPOSITORY }} --region ${{ env.AWS_REGION }} --max-items 10 || true
            echo ""
            echo "Please ensure the image has been built and pushed to ECR before deploying."
            echo "Run the 'Build and Push Docker Image' workflow first, or specify an existing image tag."
            exit 1
          fi

      - name: Update task definition with new image
        id: task-def
        uses: aws-actions/amazon-ecs-render-task-definition@v1
        with:
          task-definition: task-definition.json
          container-name: ${{ env.CONTAINER_NAME }}
          image: ${{ steps.image-tag.outputs.image_tag }}

      - name: Deploy to Amazon ECS
        uses: aws-actions/amazon-ecs-deploy-task-definition@v2
        with:
          task-definition: ${{ steps.task-def.outputs.task-definition }}
          service: ${{ env.ECS_SERVICE }}
          cluster: ${{ env.ECS_CLUSTER }}
          wait-for-service-stability: true

      - name: Deployment summary
        run: |
          echo "✅ Deployment completed successfully!"
          echo "Cluster: ${{ env.ECS_CLUSTER }}"
          echo "Service: ${{ env.ECS_SERVICE }}"
          echo "Image: ${{ steps.image-tag.outputs.image_tag }}"
