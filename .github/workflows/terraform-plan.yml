name: Terraform Plan Preview

on:
  pull_request:
    paths:
      - 'terraform/**'
      - '.github/workflows/terraform-plan.yml'
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write

jobs:
  terraform-plan:
    name: Preview Terraform Changes
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.0

      - name: Terraform Format Check
        id: fmt
        run: terraform -chdir=terraform fmt -check -recursive
        continue-on-error: true

      - name: Terraform Init
        id: init
        env:
          TF_STATE_BUCKET: ${{ vars.TF_STATE_BUCKET }}
          TF_STATE_KEY: ${{ vars.TF_STATE_KEY }}
          TF_STATE_REGION: ${{ vars.TF_STATE_REGION }}
          TF_STATE_DYNAMODB_TABLE: ${{ vars.TF_STATE_DYNAMODB_TABLE }}
        run: |
          terraform -chdir=terraform init \
            -backend-config="bucket=${TF_STATE_BUCKET}" \
            -backend-config="key=${TF_STATE_KEY}" \
            -backend-config="region=${TF_STATE_REGION}" \
            -backend-config="dynamodb_table=${TF_STATE_DYNAMODB_TABLE}"

      - name: Terraform Validate
        id: validate
        run: terraform -chdir=terraform validate -no-color

      - name: Terraform Plan
        id: plan
        run: |
          cd terraform
          terraform plan -no-color -var="aws_account_id=${{ vars.AWS_ACCOUNT_ID || '000000000000' }}" -out=tfplan.out
          terraform show -no-color tfplan.out > plan.txt
        continue-on-error: true

      - name: Format Plan Output
        id: format-plan
        if: always()
        run: |
          cd terraform
          
          # Create formatted plan summary
          echo "## ğŸ“‹ Terraform Plan Summary" > plan-summary.md
          echo "" >> plan-summary.md
          
          if [ -f plan.txt ]; then
            # Extract resource changes
            echo "### Resource Changes" >> plan-summary.md
            echo "" >> plan-summary.md
            
            # Count changes
            TO_ADD=$(grep -c "will be created" plan.txt || echo "0")
            TO_CHANGE=$(grep -c "will be updated" plan.txt || echo "0")
            TO_DESTROY=$(grep -c "will be destroyed" plan.txt || echo "0")
            
            echo "- âœ… **Resources to Add:** $TO_ADD" >> plan-summary.md
            echo "- ğŸ”„ **Resources to Change:** $TO_CHANGE" >> plan-summary.md
            echo "- âŒ **Resources to Destroy:** $TO_DESTROY" >> plan-summary.md
            echo "" >> plan-summary.md
            
            # Add plan details in collapsible section
            echo "<details>" >> plan-summary.md
            echo "<summary>ğŸ“„ Full Plan Output (click to expand)</summary>" >> plan-summary.md
            echo "" >> plan-summary.md
            echo '```terraform' >> plan-summary.md
            cat plan.txt >> plan-summary.md
            echo '```' >> plan-summary.md
            echo "</details>" >> plan-summary.md
            echo "" >> plan-summary.md
            
            # Extract and highlight key changes
            echo "### ğŸ” Key Changes Detected" >> plan-summary.md
            echo "" >> plan-summary.md
            
            # Look for specific resource types
            if grep -q "aws_ecs_service" plan.txt; then
              echo "- ğŸ³ **ECS Service** changes detected" >> plan-summary.md
            fi
            if grep -q "aws_lb" plan.txt; then
              echo "- âš–ï¸ **Load Balancer** changes detected" >> plan-summary.md
            fi
            if grep -q "aws_security_group" plan.txt; then
              echo "- ğŸ”’ **Security Group** changes detected" >> plan-summary.md
            fi
            if grep -q "aws_iam" plan.txt; then
              echo "- ğŸ”‘ **IAM** changes detected" >> plan-summary.md
            fi
            if grep -q "aws_nat_gateway" plan.txt; then
              echo "- ğŸŒ **NAT Gateway** changes detected" >> plan-summary.md
            fi
            
          else
            echo "âš ï¸ Plan file not generated" >> plan-summary.md
          fi
          
          echo "" >> plan-summary.md
          
          # Add validation status
          echo "### âœ… Validation Status" >> plan-summary.md
          echo "" >> plan-summary.md
          echo "- **Format Check:** ${{ steps.fmt.outcome == 'success' && 'âœ… Pass' || 'âš ï¸ Needs formatting' }}" >> plan-summary.md
          echo "- **Init:** ${{ steps.init.outcome == 'success' && 'âœ… Pass' || 'âŒ Failed' }}" >> plan-summary.md
          echo "- **Validate:** ${{ steps.validate.outcome == 'success' && 'âœ… Pass' || 'âŒ Failed' }}" >> plan-summary.md
          echo "- **Plan:** ${{ steps.plan.outcome == 'success' && 'âœ… Pass' || 'âŒ Failed' }}" >> plan-summary.md
          
          cat plan-summary.md

      - name: Post Plan Comment
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const planSummary = fs.readFileSync('terraform/plan-summary.md', 'utf8');
            
            const comment = `## ğŸ—ï¸ Terraform Plan Preview
            
            ${planSummary}
            
            ---
            <sub>ğŸ’¡ This plan preview helps you review infrastructure changes before applying them.</sub>
            `;
            
            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            const botComment = comments.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('ğŸ—ï¸ Terraform Plan Preview')
            );
            
            if (botComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: comment
              });
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: comment
              });
            }

      - name: Generate Job Summary
        if: always()
        run: |
          cd terraform
          cat plan-summary.md >> $GITHUB_STEP_SUMMARY
