name: Secret Scanning

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
      - develop
  schedule:
    # Run weekly on Sundays at midnight UTC
    - cron: '0 0 * * 0'

permissions:
  contents: read
  actions: read
  security-events: write

jobs:
  trufflehog:
    name: TruffleHog Secret Scan
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0  # Full git history for comprehensive scanning
      
      - name: TruffleHog OSS
        uses: trufflesecurity/trufflehog@main
        with:
          # Scan the entire repository
          path: ./
          # Scan from base branch to HEAD for PRs, entire history for pushes
          extra_args: --debug --only-verified
      
      - name: Secret scan summary
        if: always()
        run: |
          echo "## Secret Scanning Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… TruffleHog secret scanning completed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Scan Details" >> $GITHUB_STEP_SUMMARY
          echo "- **Tool:** TruffleHog OSS" >> $GITHUB_STEP_SUMMARY
          echo "- **Scope:** Full git history" >> $GITHUB_STEP_SUMMARY
          echo "- **Verified Secrets Only:** Yes" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### What Was Scanned" >> $GITHUB_STEP_SUMMARY
          echo "- API keys and tokens" >> $GITHUB_STEP_SUMMARY
          echo "- AWS credentials" >> $GITHUB_STEP_SUMMARY
          echo "- Private keys (SSH, PGP, etc.)" >> $GITHUB_STEP_SUMMARY
          echo "- Database connection strings" >> $GITHUB_STEP_SUMMARY
          echo "- OAuth tokens and secrets" >> $GITHUB_STEP_SUMMARY
          echo "- Other sensitive patterns" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Remediation" >> $GITHUB_STEP_SUMMARY
          echo "If secrets are detected:" >> $GITHUB_STEP_SUMMARY
          echo "1. **Immediately revoke** the exposed credential" >> $GITHUB_STEP_SUMMARY
          echo "2. **Remove from git history** using \`git filter-repo\` or BFG Repo-Cleaner" >> $GITHUB_STEP_SUMMARY
          echo "3. **Generate new credentials** and store them securely (environment variables, secrets manager)" >> $GITHUB_STEP_SUMMARY
          echo "4. **Update configuration** to use the new credentials" >> $GITHUB_STEP_SUMMARY
          echo "5. **Add to .trufflehog.yaml** if it's a false positive (with justification)" >> $GITHUB_STEP_SUMMARY
