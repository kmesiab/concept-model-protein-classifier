name: Security Issue Automation

# Automatically create GitHub issues for security vulnerabilities
# detected by Safety CLI, assigning them to Copilot for automated remediation

on:
  schedule:
    - cron: '0 */6 * * *'  # Run every 6 hours
  workflow_dispatch:  # Allow manual triggering
  push:
    paths:
      - '**/requirements.txt'  # Trigger on dependency changes

permissions:
  issues: write
  contents: read

jobs:
  scan-and-create-issues:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Safety CLI
        run: |
          pip install --upgrade pip
          pip install safety

      - name: Scan for vulnerabilities
        id: scan
        continue-on-error: true
        run: |
          safety check --json --output vulns.json api/requirements.txt || true
          if [ -f vulns.json ]; then
            cat vulns.json
          else
            echo '{"vulnerabilities":[]}' > vulns.json
          fi

      - name: Create issues for vulnerabilities
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          python3 << 'PYTHON_SCRIPT'
          import json
          import os
          import subprocess
          from datetime import datetime
          
          # Read vulnerability scan results
          try:
              with open('vulns.json', 'r', encoding='utf-8') as f:
                  data = json.load(f)
          except (FileNotFoundError, json.JSONDecodeError) as e:
              print(f"Error reading vulns.json: {e}")
              exit(0)
          
          vulnerabilities = data.get('vulnerabilities', [])
          
          if not vulnerabilities:
              print("No vulnerabilities found")
              exit(0)
          
          # Get existing security issues to avoid duplicates
          try:
              result = subprocess.run(
                  ['gh', 'issue', 'list', '--label', 'security,automated', '--json', 'title'],
                  capture_output=True, text=True, check=True
              )
              existing_issues = json.loads(result.stdout)
              existing_titles = {issue['title'] for issue in existing_issues}
          except (subprocess.CalledProcessError, json.JSONDecodeError) as e:
              print(f"Error fetching existing issues: {e}")
              existing_titles = set()
          
          issues_created = 0
          
          for vuln in vulnerabilities:
              package = vuln.get('package_name', 'unknown')
              current_version = vuln.get('analyzed_version', 'unknown')
              cve_id = vuln.get('CVE') or vuln.get('vulnerability_id', 'N/A')
              severity = vuln.get('severity', 'unknown')
              
              # Only create issues for medium or higher severity
              if severity.lower() not in ['medium', 'high', 'critical']:
                  continue
              
              title = f"[Security] Upgrade {package} to fix {cve_id}"
              
              # Skip if issue already exists
              if title in existing_titles:
                  print(f"Issue already exists: {title}")
                  continue
              
              # Get fix version
              fix_version = vuln.get('recommended_version') or vuln.get('secure_versions', ['latest'])[0] if vuln.get('secure_versions') else 'latest'
              
              # Create issue body
              body = f"""## üîí Security Vulnerability Detected
          
          **Package:** `{package}`  
          **Current Version:** `{current_version}`  
          **Severity:** {severity.upper()}  
          **CVE:** {cve_id}  
          
          ### üìã CVE Description
          {vuln.get('advisory', 'No description available')}
          
          ### üîß Remediation
          **Recommended action:** Upgrade to version `{fix_version}`
          
          **Affected file:** `api/requirements.txt`
          
          ### ü§ñ Action Required
          @Copilot please:
          1. Update `{package}` to version `{fix_version}` in `api/requirements.txt`
          2. Update version constraint to use `>=` instead of `==` to allow future security patches
          3. Run the test suite to ensure compatibility
          4. Open a PR with the changes
          5. Include "Fixes #{{issue_number}}" in the PR description
          
          ### üìä References
          - **CVE Details:** https://cve.mitre.org/cgi-bin/cvename.cgi?name={cve_id}
          - **Safety Report:** https://platform.safetycli.com/codebases/concept-model-protein-classifier/findings
          
          ---
          *This issue was automatically created by the security automation system.*  
          *Last scanned: {datetime.utcnow().strftime('%Y-%m-%d %H:%M:%S')} UTC*
          """
              
              # Create the issue
              try:
                  subprocess.run([
                      'gh', 'issue', 'create',
                      '--title', title,
                      '--body', body,
                      '--label', 'security,automated,dependency-upgrade',
                      '--assignee', 'Copilot'
                  ], check=True)
                  print(f"‚úÖ Created issue: {title}")
                  issues_created += 1
              except subprocess.CalledProcessError as e:
                  print(f"‚ùå Failed to create issue for {package}: {e}")
          
          print(f"\nSummary: Created {issues_created} security issue(s)")
          PYTHON_SCRIPT
