name: Security Issue Automation

# Automatically create GitHub issues for security vulnerabilities detected by
# Safety CLI. This workflow scans dependencies for known vulnerabilities and
# creates labeled GitHub issues with remediation details for medium+ severity
# findings.
#
# Workflow triggers:
# - Every 6 hours on a schedule
# - When api/requirements.txt is modified
# - Manual dispatch
#
# The workflow prevents duplicate issues by checking existing security issues
# before creating new ones.

on:
  schedule:
    - cron: '0 */6 * * *'  # Run every 6 hours
  workflow_dispatch:  # Allow manual triggering
  push:
    paths:
      - 'api/requirements.txt'  # Trigger only on API requirements changes

# Limit concurrent workflow runs to prevent conflicts when creating issues
concurrency:
  group: security-issue-automation
  cancel-in-progress: false

permissions:
  issues: write
  contents: read

jobs:
  scan-and-create-issues:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.12'

      - name: Validate required tools
        run: |
          # Verify gh CLI is available
          if ! command -v gh &> /dev/null; then
            echo "❌ Error: GitHub CLI (gh) is not installed"
            exit 1
          fi
          echo "✅ GitHub CLI is available"
          
          # Verify Python is available
          if ! command -v python3 &> /dev/null; then
            echo "❌ Error: Python 3 is not installed"
            exit 1
          fi
          echo "✅ Python 3 is available"

      - name: Install Safety CLI
        run: |
          pip install --upgrade pip
          pip install safety

      - name: Scan for vulnerabilities
        id: scan
        continue-on-error: true
        run: |
          # Use modern Safety CLI 3.x syntax with JSON output
          # Redirect output to file for processing
          (safety scan --output json --detailed-output > vulns.json) || true
          
          # Ensure vulns.json exists even if scan fails
          if [ -f vulns.json ]; then
            echo "✅ Vulnerability scan completed"
            cat vulns.json
          else
            echo "⚠️  No scan results found, creating empty results file"
            echo '{"vulnerabilities":[]}' > vulns.json
          fi

      - name: Create issues for vulnerabilities
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # Make the script executable
          chmod +x .github/scripts/create_security_issues.py
          
          # Run the security issue creation script
          python3 .github/scripts/create_security_issues.py
