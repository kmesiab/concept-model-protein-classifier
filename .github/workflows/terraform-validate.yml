name: Terraform Validation Pipeline

on:
  pull_request:
    paths:
      - 'terraform/**'
      - '.github/workflows/terraform-validate.yml'
  push:
    branches:
      - main
    paths:
      - 'terraform/**'

permissions:
  contents: read
  pull-requests: write  # Required for Infracost to post PR comments
  id-token: write  # Required for OIDC (if needed in future)
  security-events: write  # Required for uploading SARIF files

env:
  COST_THRESHOLD: 125  # Monthly cost threshold in USD

jobs:
  # Gate 1: TFLint - Catch provider-specific errors and enforce naming conventions
  tflint:
    name: Gate 1 - TFLint
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.0

      - name: Cache TFLint plugin directory
        uses: actions/cache@v4
        with:
          path: ~/.tflint.d/plugins
          key: ${{ runner.os }}-tflint-${{ hashFiles('.tflint.hcl') }}

      - name: Setup TFLint
        uses: terraform-linters/setup-tflint@v6
        with:
          tflint_version: latest

      - name: Show TFLint version
        run: tflint --version

      - name: Create TFLint config
        run: |
          cat > .tflint.hcl <<EOF
          plugin "aws" {
            enabled = true
            version = "0.29.0"
            source  = "github.com/terraform-linters/tflint-ruleset-aws"
          }

          rule "terraform_naming_convention" {
            enabled = true
          }

          rule "terraform_documented_variables" {
            enabled = true
          }

          rule "terraform_typed_variables" {
            enabled = true
          }

          rule "terraform_unused_declarations" {
            enabled = true
          }

          rule "terraform_deprecated_index" {
            enabled = true
          }

          rule "terraform_comment_syntax" {
            enabled = true
          }

          rule "terraform_required_version" {
            enabled = true
          }

          rule "terraform_required_providers" {
            enabled = true
          }
          EOF

      - name: Init TFLint
        run: tflint --init
        working-directory: terraform

      - name: Run TFLint
        id: tflint
        run: tflint --format compact --recursive
        working-directory: terraform

      - name: TFLint Summary
        if: always()
        run: |
          echo "### üîç Gate 1: TFLint Results" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.tflint.outcome }}" == "success" ]; then
            echo "‚úÖ TFLint validation passed - No provider-specific issues found" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå TFLint found issues - Please review and fix" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Fail the job if TFLint found issues
          if [ "${{ steps.tflint.outcome }}" != "success" ]; then
            exit 1
          fi

  # Gate 2: Security Scanner - Scan for security issues
  security-scan:
    name: Gate 2 - Security Scan (Trivy)
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Run Trivy security scan
        id: trivy
        uses: aquasecurity/trivy-action@0.33.1
        with:
          scan-type: 'config'
          scan-ref: 'terraform'
          format: 'table'
          exit-code: '1'
          severity: 'MEDIUM,HIGH,CRITICAL'

      - name: Run Trivy with SARIF output
        id: trivy_sarif
        if: always()  # Run even if previous step fails
        uses: aquasecurity/trivy-action@0.33.1
        with:
          scan-type: 'config'
          scan-ref: 'terraform'
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'MEDIUM,HIGH,CRITICAL'

      - name: Verify SARIF file exists
        id: verify_sarif
        if: always()
        run: |
          if [ -f "trivy-results.sarif" ]; then
            echo "sarif_exists=true" >> $GITHUB_OUTPUT
            echo "‚úÖ SARIF file created successfully"
          else
            echo "sarif_exists=false" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è WARNING: SARIF file not found at trivy-results.sarif"
          fi

      - name: Upload SARIF file
        uses: github/codeql-action/upload-sarif@v4
        if: always() && steps.verify_sarif.outputs.sarif_exists == 'true'
        with:
          sarif_file: trivy-results.sarif
          category: trivy-config

      - name: Security Scan Summary
        if: always()
        run: |
          echo "### üîí Gate 2: Security Scan Results" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.trivy.outcome }}" == "success" ]; then
            echo "‚úÖ No security issues found" >> $GITHUB_STEP_SUMMARY
            echo "- No public S3 buckets" >> $GITHUB_STEP_SUMMARY
            echo "- No overly permissive security groups" >> $GITHUB_STEP_SUMMARY
            echo "- Encryption enabled where required" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå Security issues detected - Please review" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Security findings have been uploaded to the Security tab." >> $GITHUB_STEP_SUMMARY
          fi
          
          # Fail the job if security issues were found
          if [ "${{ steps.trivy.outcome }}" != "success" ]; then
            exit 1
          fi

  # Gate 3: Infracost - Show cost estimates
  infracost:
    name: Gate 3 - Cost Estimation
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Infracost
        uses: infracost/actions/setup@v3
        with:
          api-key: ${{ secrets.INFRACOST_API_KEY }}

      - name: Generate Infracost JSON
        id: infracost_json
        run: |
          # Setup Infracost
          infracost breakdown --path=terraform \
            --terraform-init-flags="-backend=false" \
            --terraform-plan-flags="-var=aws_account_id=${{ vars.AWS_ACCOUNT_ID || '462498369025' }}" \
            --format=json \
            --out-file=/tmp/infracost.json
        continue-on-error: true

      - name: Check cost threshold
        id: cost_check
        if: always()
        run: |
          COST_THRESHOLD=${{ env.COST_THRESHOLD }}
          
          if [ -f /tmp/infracost.json ]; then
            # Extract total monthly cost from Infracost JSON
            TOTAL_COST=$(jq -r '.totalMonthlyCost | tonumber' /tmp/infracost.json 2>/dev/null || echo "0")
            
            echo "total_cost=$TOTAL_COST" >> $GITHUB_OUTPUT
            echo "threshold=$COST_THRESHOLD" >> $GITHUB_OUTPUT
            
            # Compare costs (handle decimal comparison)
            if (( $(echo "$TOTAL_COST > $COST_THRESHOLD" | bc -l) )); then
              echo "cost_exceeded=true" >> $GITHUB_OUTPUT
              echo "‚ùå Cost threshold exceeded: \$$TOTAL_COST/month > \$$COST_THRESHOLD/month" >> $GITHUB_STEP_SUMMARY
              exit 1
            else
              echo "cost_exceeded=false" >> $GITHUB_OUTPUT
              echo "‚úÖ Cost within threshold: \$$TOTAL_COST/month ‚â§ \$$COST_THRESHOLD/month" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "‚ö†Ô∏è Infracost analysis not available - skipping cost check" >> $GITHUB_STEP_SUMMARY
            echo "cost_exceeded=false" >> $GITHUB_OUTPUT
          fi

      - name: Post Cost Estimation Comment
        id: post_cost_comment
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            // Get cost threshold from the previous step output (defaults to 125)
            const COST_THRESHOLD = ${{ steps.cost_check.outputs.threshold || 125 }};
            
            // Read Infracost JSON if it exists
            let costComment = '';
            const infracostPath = '/tmp/infracost.json';
            
            // Check if file exists before attempting to read
            if (!fs.existsSync(infracostPath)) {
              console.error(`Infracost JSON file not found at ${infracostPath}`);
              costComment = `## üí∞ Gate 3 - Cost Estimation Summary\n\n`;
              costComment += `‚ö†Ô∏è Infracost analysis not available\n\n`;
              costComment += `**Estimated Monthly Costs (Cost-Optimized Configuration):**\n`;
              costComment += `- ECS Fargate (1 task, 0.5 vCPU, 1GB): ~$18/month\n`;
              costComment += `- Application Load Balancer: ~$22/month\n`;
              costComment += `- NAT Gateway (1): ~$35/month\n`;
              costComment += `- Route 53 Hosted Zone: ~$0.50/month\n`;
              costComment += `- CloudWatch Logs + ECR: ~$2/month\n`;
              costComment += `- Data Transfer: Variable (estimate $5-10/month)\n\n`;
              costComment += `**Total Estimated: ~$82-92/month**\n`;
              costComment += `**Cost Threshold: $${COST_THRESHOLD}/month** ‚úÖ\n\n`;
              costComment += `To enable automated cost tracking, add INFRACOST_API_KEY secret.\n`;
              costComment += `Get free API key at: https://www.infracost.io/\n\n`;
              costComment += `---\n`;
              costComment += `<sub>üí° Enable Infracost for detailed cost breakdown</sub>`;
            } else {
              try {
                const infracostData = JSON.parse(fs.readFileSync(infracostPath, 'utf8'));
                const totalCost = parseFloat(infracostData.totalMonthlyCost || 0);
                const costExceeded = totalCost > COST_THRESHOLD;
                
                // Build the cost breakdown table
                costComment = `## üí∞ Gate 3 - Cost Estimation Summary\n\n`;
                
                // Cost status (single, consolidated threshold display)
                if (costExceeded) {
                  costComment += `‚ùå **Cost exceeds acceptable threshold:** $${totalCost.toFixed(2)}/month > $${COST_THRESHOLD}/month\n\n`;
                } else {
                  costComment += `‚úÖ **Cost within acceptable threshold:** $${totalCost.toFixed(2)}/month ‚â§ $${COST_THRESHOLD}/month\n\n`;
                }
                
                costComment += `### üí∞ Gate 3: Cost Estimation\n\n`;
                costComment += `‚úÖ Infracost analysis completed\n\n`;
                
                // Add resource breakdown if available
                if (infracostData.projects && infracostData.projects.length > 0) {
                  costComment += `### üìä Resource Cost Breakdown\n\n`;
                  costComment += `| Resource | Monthly Cost |\n`;
                  costComment += `|----------|-------------|\n`;
                  
                  for (const project of infracostData.projects) {
                    if (project.breakdown && project.breakdown.resources) {
                      for (const resource of project.breakdown.resources) {
                        const resourceCost = parseFloat(resource.monthlyCost || 0);
                        if (resourceCost > 0) {
                          costComment += `| ${resource.name} | $${resourceCost.toFixed(2)} |\n`;
                        }
                      }
                    }
                  }
                  
                  costComment += `\n**Total Monthly Cost:** $${totalCost.toFixed(2)}\n`;
                }
                
                costComment += `\n---\n`;
                costComment += `<sub>üí° Cost estimates are provided by [Infracost](https://www.infracost.io/)</sub>`;
                
              } catch (error) {
                // Log the error for debugging - JSON parsing or other read errors
                console.error('Error parsing Infracost JSON:', error.message);
                console.error('Stack trace:', error.stack);
                
                // Fallback to manual cost estimates
                costComment = `## üí∞ Gate 3 - Cost Estimation Summary\n\n`;
                costComment += `‚ö†Ô∏è Infracost data could not be parsed\n\n`;
                costComment += `**Estimated Monthly Costs (Cost-Optimized Configuration):**\n`;
                costComment += `- ECS Fargate (1 task, 0.5 vCPU, 1GB): ~$18/month\n`;
                costComment += `- Application Load Balancer: ~$22/month\n`;
                costComment += `- NAT Gateway (1): ~$35/month\n`;
                costComment += `- Route 53 Hosted Zone: ~$0.50/month\n`;
                costComment += `- CloudWatch Logs + ECR: ~$2/month\n`;
                costComment += `- Data Transfer: Variable (estimate $5-10/month)\n\n`;
                costComment += `**Total Estimated: ~$82-92/month**\n`;
                costComment += `**Cost Threshold: $${COST_THRESHOLD}/month** ‚úÖ\n\n`;
                costComment += `To enable automated cost tracking, add INFRACOST_API_KEY secret.\n`;
                costComment += `Get free API key at: https://www.infracost.io/\n\n`;
                costComment += `---\n`;
                costComment += `<sub>üí° Enable Infracost for detailed cost breakdown</sub>`;
              }
            }
            
            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            // Look for existing cost estimation comment by checking for the unique identifier in the comment body
            // This is more robust than checking bot username which might vary by configuration
            const botComment = comments.find(comment => 
              comment.body.includes('üí∞ Gate 3 - Cost Estimation Summary')
            );
            
            if (botComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: costComment
              });
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: costComment
              });
            }
        continue-on-error: true

      - name: Cost Estimation Summary (Manual)
        if: always()
        run: |
          echo "### üí∞ Gate 3: Cost Estimation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -n "${{ secrets.INFRACOST_API_KEY }}" ]; then
            echo "‚úÖ Infracost analysis completed" >> $GITHUB_STEP_SUMMARY
            echo "Check the PR comment for detailed cost breakdown" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            if [ "${{ steps.cost_check.outputs.cost_exceeded }}" == "true" ]; then
              echo "‚ùå **COST THRESHOLD EXCEEDED**" >> $GITHUB_STEP_SUMMARY
              echo "- Current: \$${{ steps.cost_check.outputs.total_cost }}/month" >> $GITHUB_STEP_SUMMARY
              echo "- Threshold: \$${{ steps.cost_check.outputs.threshold }}/month" >> $GITHUB_STEP_SUMMARY
              echo "- **Action Required:** Reduce infrastructure costs before merging" >> $GITHUB_STEP_SUMMARY
            else
              echo "‚úÖ Cost within acceptable threshold (\$125/month)" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "‚ö†Ô∏è Infracost API key not configured" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Estimated Monthly Costs (Cost-Optimized Configuration):**" >> $GITHUB_STEP_SUMMARY
            echo "- ECS Fargate (1 task, 0.5 vCPU, 1GB): ~\$18/month" >> $GITHUB_STEP_SUMMARY
            echo "- Application Load Balancer: ~\$22/month" >> $GITHUB_STEP_SUMMARY
            echo "- NAT Gateway (1): ~\$35/month" >> $GITHUB_STEP_SUMMARY
            echo "- Route 53 Hosted Zone: ~\$0.50/month" >> $GITHUB_STEP_SUMMARY
            echo "- CloudWatch Logs + ECR: ~\$2/month" >> $GITHUB_STEP_SUMMARY
            echo "- Data Transfer: Variable (estimate \$5-10/month)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Total Estimated: ~\$82-92/month**" >> $GITHUB_STEP_SUMMARY
            echo "**Cost Threshold: \$125/month** ‚úÖ" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "To enable automated cost tracking and enforcement, add INFRACOST_API_KEY secret" >> $GITHUB_STEP_SUMMARY
            echo "Get free API key at: https://www.infracost.io/" >> $GITHUB_STEP_SUMMARY
          fi

  # Summary job - only runs if all gates pass
  validation-summary:
    name: Validation Summary
    runs-on: ubuntu-latest
    needs: [tflint, security-scan, infracost]
    if: always()
    
    steps:
      - name: Check gate results
        run: |
          echo "## üöÄ Triple-Gated Terraform Validation Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.tflint.result }}" == "success" ]; then
            echo "‚úÖ **Gate 1 (TFLint):** PASSED" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå **Gate 1 (TFLint):** FAILED" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ needs.security-scan.result }}" == "success" ]; then
            echo "‚úÖ **Gate 2 (Security):** PASSED" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå **Gate 2 (Security):** FAILED" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ needs.infracost.result }}" == "success" ] || [ "${{ needs.infracost.result }}" == "skipped" ]; then
            echo "‚úÖ **Gate 3 (Cost Est):** COMPLETED" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ö†Ô∏è **Gate 3 (Cost Est):** NEEDS REVIEW" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.tflint.result }}" == "success" ] && [ "${{ needs.security-scan.result }}" == "success" ]; then
            echo "### üéâ All critical gates passed! Infrastructure changes are approved." >> $GITHUB_STEP_SUMMARY
          else
            echo "### ‚ö†Ô∏è Some gates failed. Please review and address the issues before merging." >> $GITHUB_STEP_SUMMARY
          fi

      - name: Fail if critical gates failed
        if: needs.tflint.result != 'success' || needs.security-scan.result != 'success'
        run: |
          echo "Critical validation gates failed"
          exit 1
