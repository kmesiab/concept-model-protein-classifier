name: Security

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  schedule:
    # Run weekly security scans on Monday at 9 AM UTC
    - cron: '0 9 * * 1'
  workflow_dispatch:

permissions:
  contents: read
  security-events: write

jobs:
  security:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.12'

      - name: Cache pip packages
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-security-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-security-
            ${{ runner.os }}-pip-

      - name: Install security tools
        run: |
          python -m pip install --upgrade pip
          pip install bandit pip-audit
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      - name: Bandit security scan
        run: |
          echo "Running Bandit security scan..."
          mkdir -p reports
          bandit -r . --configfile pyproject.toml -f json -o reports/bandit-report.json
          bandit -r . --configfile pyproject.toml -f txt
        continue-on-error: false

      - name: Check Bandit report exists
        if: always()
        run: |
          .github/scripts/check-file-exists.sh reports/bandit-report.json "Bandit JSON report"
        continue-on-error: false

      - name: Annotate Bandit findings
        if: always()
        run: |
          python3 .github/scripts/annotate-bandit-findings.py reports/bandit-report.json HIGH
        continue-on-error: true

      - name: Upload Bandit report
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: bandit-report
          path: reports/bandit-report.json

      - name: Run Safety CLI to check for vulnerabilities
        uses: pyupio/safety-action@v1
        with:
          api-key: ${{ secrets.SAFETY_API_KEY }}
        continue-on-error: true

      - name: Pip audit
        run: |
          echo "Running pip-audit for dependency vulnerabilities..."
          pip-audit --desc --format json --output reports/pip-audit-report.json || true
          pip-audit --desc || echo "âš ï¸ pip-audit found vulnerabilities"
        continue-on-error: true

      - name: Check pip-audit report exists
        if: always()
        run: |
          .github/scripts/check-file-exists.sh reports/pip-audit-report.json "pip-audit JSON report"
        continue-on-error: false

      - name: Annotate pip-audit findings
        if: always()
        run: |
          python3 .github/scripts/annotate-pip-audit-findings.py reports/pip-audit-report.json
        continue-on-error: true

      - name: Upload pip-audit report
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: pip-audit-report
          path: reports/pip-audit-report.json

      - name: Trivy filesystem scan
        uses: aquasecurity/trivy-action@0.33.1
        with:
          scan-type: 'fs'
          scan-ref: '.'
          scanners: 'vuln,secret,misconfig,license'
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH,MEDIUM'
          ignore-unfixed: true
          exit-code: '0'
        continue-on-error: true

      - name: Check Trivy SARIF exists
        if: always()
        run: |
          .github/scripts/check-file-exists.sh trivy-results.sarif "Trivy SARIF report"
        continue-on-error: false

      - name: Upload Trivy scan results to GitHub Security
        if: always()
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: 'trivy-results.sarif'
          category: trivy-filesystem
        continue-on-error: true

      - name: Upload Trivy SARIF artifact
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: trivy-results
          path: trivy-results.sarif

      - name: Trivy filesystem scan (JSON output for parsing)
        uses: aquasecurity/trivy-action@0.33.1
        if: always()
        with:
          scan-type: 'fs'
          scan-ref: '.'
          scanners: 'vuln,secret,misconfig,license'
          format: 'json'
          output: 'trivy-results.json'
          severity: 'CRITICAL,HIGH,MEDIUM'
          ignore-unfixed: true
          exit-code: '0'
        continue-on-error: true

      - name: Trivy filesystem scan (table output)
        uses: aquasecurity/trivy-action@0.33.1
        if: always()
        with:
          scan-type: 'fs'
          scan-ref: '.'
          scanners: 'vuln,secret,misconfig,license'
          format: 'table'
          severity: 'CRITICAL,HIGH,MEDIUM'
          ignore-unfixed: true
          exit-code: '0'
        continue-on-error: true

      - name: Check Trivy JSON exists
        if: always()
        run: |
          .github/scripts/check-file-exists.sh trivy-results.json "Trivy JSON report"
        continue-on-error: false

      - name: Annotate Trivy findings
        if: always()
        run: |
          python3 .github/scripts/annotate-trivy-findings.py trivy-results.json HIGH
        continue-on-error: true

      - name: Parse Trivy results and display summary
        if: always()
        run: |
          echo "## ðŸ”’ Trivy Security Scan Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          REPORT=trivy-results.json
          if [ -f "$REPORT" ]; then
            # Count total vulnerabilities by type
            TOTAL_VULNS=$(jq -r '(.Results // []) | map(.Vulnerabilities // []) | flatten | length' "$REPORT")
            TOTAL_SECRETS=$(jq -r '(.Results // []) | map(.Secrets // []) | flatten | length' "$REPORT")
            TOTAL_MISCONFIGS=$(jq -r '(.Results // []) | map(.Misconfigurations // []) | flatten | length' "$REPORT")
            TOTAL_LICENSES=$(jq -r '(.Results // []) | map(.Licenses // []) | flatten | length' "$REPORT")

            # Normalize TOTAL_* variables to ensure they are numeric before arithmetic
            for var_name in TOTAL_VULNS TOTAL_SECRETS TOTAL_MISCONFIGS TOTAL_LICENSES; do
              value=${!var_name:-0}
              if ! [[ "$value" =~ ^[0-9]+$ ]]; then
                value=0
              fi
              printf -v "$var_name" '%d' "$value"
            done

            # Count vulnerabilities by severity
            CRITICAL_VULNS=$(jq -r '(.Results // []) | map(.Vulnerabilities // []) | flatten | map(select(.Severity=="CRITICAL")) | length' "$REPORT")
            HIGH_VULNS=$(jq -r '(.Results // []) | map(.Vulnerabilities // []) | flatten | map(select(.Severity=="HIGH")) | length' "$REPORT")
            MEDIUM_VULNS=$(jq -r '(.Results // []) | map(.Vulnerabilities // []) | flatten | map(select(.Severity=="MEDIUM")) | length' "$REPORT")

            # Count misconfigurations by severity
            CRITICAL_MISCONFIGS=$(jq -r '(.Results // []) | map(.Misconfigurations // []) | flatten | map(select(.Severity=="CRITICAL")) | length' "$REPORT")
            HIGH_MISCONFIGS=$(jq -r '(.Results // []) | map(.Misconfigurations // []) | flatten | map(select(.Severity=="HIGH")) | length' "$REPORT")
            MEDIUM_MISCONFIGS=$(jq -r '(.Results // []) | map(.Misconfigurations // []) | flatten | map(select(.Severity=="MEDIUM")) | length' "$REPORT")

            # Display summary table
            echo "### ðŸ“Š Finding Summary" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| Category | Critical | High | Medium | Total |" >> $GITHUB_STEP_SUMMARY
            echo "|----------|----------|------|--------|-------|" >> $GITHUB_STEP_SUMMARY
            echo "| Vulnerabilities | $CRITICAL_VULNS | $HIGH_VULNS | $MEDIUM_VULNS | $TOTAL_VULNS |" >> $GITHUB_STEP_SUMMARY
            echo "| Misconfigurations | $CRITICAL_MISCONFIGS | $HIGH_MISCONFIGS | $MEDIUM_MISCONFIGS | $TOTAL_MISCONFIGS |" >> $GITHUB_STEP_SUMMARY
            echo "| Secrets | - | - | - | $TOTAL_SECRETS |" >> $GITHUB_STEP_SUMMARY
            echo "| Licenses | - | - | - | $TOTAL_LICENSES |" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            # Calculate total findings
            TOTAL=$((TOTAL_VULNS + TOTAL_SECRETS + TOTAL_MISCONFIGS + TOTAL_LICENSES))

            if [ "$TOTAL" -gt 0 ]; then
              echo "### âš ï¸ Detailed Findings" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY

              # Display vulnerabilities table if any exist
              if [ "$TOTAL_VULNS" -gt 0 ]; then
                echo "#### Vulnerabilities" >> $GITHUB_STEP_SUMMARY
                echo "" >> $GITHUB_STEP_SUMMARY
                echo "| Package | Vulnerability | Severity | Fixed Version |" >> $GITHUB_STEP_SUMMARY
                echo "|---------|---------------|----------|---------------|" >> $GITHUB_STEP_SUMMARY
                jq -r '(.Results // []) | map(.Vulnerabilities // []) | flatten |
                       map(select(.Severity=="CRITICAL" or .Severity=="HIGH" or .Severity=="MEDIUM")) |
                       sort_by(.Severity) | reverse |
                       .[] | "| \(.PkgName // "Unknown") | \(.VulnerabilityID // "N/A") | \(.Severity) | \(.FixedVersion // "No fix available") |"' \
                       "$REPORT" >> $GITHUB_STEP_SUMMARY || echo "| Error parsing vulnerabilities | - | - | - |" >> $GITHUB_STEP_SUMMARY
                echo "" >> $GITHUB_STEP_SUMMARY
              fi

              # Display misconfigurations table if any exist
              if [ "$TOTAL_MISCONFIGS" -gt 0 ]; then
                echo "#### Misconfigurations" >> $GITHUB_STEP_SUMMARY
                echo "" >> $GITHUB_STEP_SUMMARY
                echo "| ID | Title | Severity | File |" >> $GITHUB_STEP_SUMMARY
                echo "|----|-------|----------|------|" >> $GITHUB_STEP_SUMMARY
                jq -r '(.Results // []) | map(select(.Misconfigurations != null)) |
                       .[] | .Target as $target |
                       (.Misconfigurations // []) |
                       map(select(.Severity=="CRITICAL" or .Severity=="HIGH" or .Severity=="MEDIUM")) |
                       sort_by(.Severity) | reverse |
                       .[] | "| \(.ID // "N/A") | \(.Title // "Unknown") | \(.Severity) | \($target) |"' \
                       "$REPORT" >> $GITHUB_STEP_SUMMARY || echo "| Error parsing misconfigurations | - | - | - |" >> $GITHUB_STEP_SUMMARY
                echo "" >> $GITHUB_STEP_SUMMARY
              fi

              # Display secrets if any exist
              if [ "$TOTAL_SECRETS" -gt 0 ]; then
                echo "#### ðŸš¨ Secrets Detected" >> $GITHUB_STEP_SUMMARY
                echo "" >> $GITHUB_STEP_SUMMARY
                echo "âš ï¸ **$TOTAL_SECRETS secret(s) detected in the repository!**" >> $GITHUB_STEP_SUMMARY
                echo "" >> $GITHUB_STEP_SUMMARY
                echo "| Rule ID | File | Line | Severity |" >> $GITHUB_STEP_SUMMARY
                echo "|---------|------|------|----------|" >> $GITHUB_STEP_SUMMARY
                jq -r '(.Results // []) | map(select(.Secrets != null)) |
                       .[] | .Target as $target |
                       (.Secrets // []) |
                       .[] | "| \(.RuleID // "Unknown") | \($target) | \(.StartLine // "N/A") | \(.Severity // "UNKNOWN") |"' \
                       "$REPORT" >> $GITHUB_STEP_SUMMARY || echo "| Error parsing secrets | - | - | - |" >> $GITHUB_STEP_SUMMARY
                echo "" >> $GITHUB_STEP_SUMMARY
              fi

              echo "---" >> $GITHUB_STEP_SUMMARY
              echo "**Status:** âš ï¸ $TOTAL finding(s) detected" >> $GITHUB_STEP_SUMMARY
            else
              echo "### âœ… No Security Issues Found" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "All scans completed successfully with no findings." >> $GITHUB_STEP_SUMMARY
            fi

            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ“„ Full SARIF report uploaded to GitHub Security tab" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Trivy report file not found at $REPORT" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Security scan summary
        if: always()
        run: |
          echo "## Security Scan Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Bandit: Python code security analysis completed" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Safety: Dependency vulnerability check completed" >> $GITHUB_STEP_SUMMARY
          echo "âœ… pip-audit: Additional dependency audit completed" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Trivy: Filesystem vulnerability scan completed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“Š Check artifacts for detailed reports" >> $GITHUB_STEP_SUMMARY
