name: Terraform Apply

on:
  workflow_dispatch:
    inputs:
      confirm:
        description: 'Type "apply" to confirm infrastructure changes'
        required: true
        type: string

permissions:
  contents: read
  id-token: write
  pull-requests: write

jobs:
  validate:
    name: Pre-Apply Validation (Triple-Gated)
    runs-on: ubuntu-latest

    steps:
      - name: Verify Confirmation
        run: |
          if [ "${{ inputs.confirm }}" != "apply" ]; then
            echo "âŒ Confirmation failed. You must type 'apply' to proceed."
            exit 1
          fi
          echo "âœ… Confirmation received. Proceeding with validation..."

      - name: Checkout code
        uses: actions/checkout@v6

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ vars.AWS_ACCOUNT_ID }}:role/github-actions-terraform
          aws-region: ${{ vars.TF_STATE_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.0

      - name: Setup TFLint
        uses: terraform-linters/setup-tflint@v4
        with:
          tflint_version: latest

      - name: Terraform Init
        env:
          TF_STATE_BUCKET: ${{ vars.TF_STATE_BUCKET }}
          TF_STATE_KEY: ${{ vars.TF_STATE_KEY }}
          TF_STATE_REGION: ${{ vars.TF_STATE_REGION }}
          TF_STATE_DYNAMODB_TABLE: ${{ vars.TF_STATE_DYNAMODB_TABLE }}
        run: |
          terraform -chdir=terraform init \
            -backend-config="bucket=${TF_STATE_BUCKET}" \
            -backend-config="key=${TF_STATE_KEY}" \
            -backend-config="region=${TF_STATE_REGION}" \
            -backend-config="dynamodb_table=${TF_STATE_DYNAMODB_TABLE}"

      # Gate 1: TFLint
      - name: Gate 1 - TFLint Validation
        run: |
          cd terraform
          tflint --init
          echo "ðŸ” Running TFLint validation..."
          tflint --format compact --minimum-failure-severity=error
          echo "âœ… Gate 1 (TFLint) PASSED"

      # Gate 2: tfsec Security Scan
      - name: Gate 2 - tfsec Security Scan
        uses: aquasecurity/tfsec-action@v1.0.3
        with:
          working_directory: terraform
          soft_fail: false
          format: default
          continue-on-error: false

      - name: Gate 2 Status
        run: echo "âœ… Gate 2 (tfsec) PASSED"

      # Gate 3: Cost Estimation
      - name: Setup Infracost
        uses: infracost/actions/setup@v3
        with:
          api-key: ${{ secrets.INFRACOST_API_KEY }}

      - name: Gate 3 - Cost Estimation
        continue-on-error: true # Skip cost estimation gate for now
        run: |
          cd terraform
          echo "ðŸ’° Generating cost estimate..."
          infracost breakdown --path . \
            --terraform-var="aws_account_id=${{ vars.AWS_ACCOUNT_ID || '000000000000' }}" \
            --format json \
            --out-file /tmp/infracost.json
          
          # Extract total monthly cost
          TOTAL_COST=$(jq -r '.totalMonthlyCost' /tmp/infracost.json)
          THRESHOLD=125
          
          echo "ðŸ“Š Total Monthly Cost: \$$TOTAL_COST"
          echo "ðŸŽ¯ Cost Threshold: \$$THRESHOLD"
          
          # Compare costs (using bc for decimal comparison)
          if [ $(echo "$TOTAL_COST > $THRESHOLD" | bc -l) -eq 1 ]; then
            echo "âŒ COST THRESHOLD EXCEEDED!"
            echo "   Estimated: \$$TOTAL_COST/month"
            echo "   Threshold: \$$THRESHOLD/month"
            echo "   Overage: \$$(echo "$TOTAL_COST - $THRESHOLD" | bc -l)/month"
            exit 1
          fi
          
          echo "âœ… Gate 3 (Cost Estimation) PASSED - Under threshold"

  terraform-apply:
    name: Apply Terraform Changes
    runs-on: ubuntu-latest
    needs: validate
    environment:
      name: production
      url: https://api.proteinclassifier.com

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ vars.AWS_ACCOUNT_ID }}:role/github-actions-terraform
          aws-region: ${{ vars.TF_STATE_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.0

      - name: Terraform Init
        env:
          TF_STATE_BUCKET: ${{ vars.TF_STATE_BUCKET }}
          TF_STATE_KEY: ${{ vars.TF_STATE_KEY }}
          TF_STATE_REGION: ${{ vars.TF_STATE_REGION }}
          TF_STATE_DYNAMODB_TABLE: ${{ vars.TF_STATE_DYNAMODB_TABLE }}
        run: |
          terraform -chdir=terraform init \
            -backend-config="bucket=${TF_STATE_BUCKET}" \
            -backend-config="key=${TF_STATE_KEY}" \
            -backend-config="region=${TF_STATE_REGION}" \
            -backend-config="dynamodb_table=${TF_STATE_DYNAMODB_TABLE}"

      - name: Terraform Validate
        run: terraform -chdir=terraform validate

      - name: Terraform Plan
        id: plan
        run: |
          cd terraform
          terraform plan \
            -var="aws_account_id=${{ vars.AWS_ACCOUNT_ID || '000000000000' }}" \
            -out=tfplan.out \
            -no-color
          
          # Show the plan
          terraform show -no-color tfplan.out

      - name: Import Existing Resources (if any)
        continue-on-error: true
        run: |
          cd terraform
          echo "ðŸ”„ Attempting to import any existing resources..."
            
          # Import with || true to continue even if resource doesn't exist or is already in state
          terraform import aws_s3_bucket.alb_logs protein-classifier-alb-logs-462498369025 2>/dev/null || echo "S3 bucket: already in state or doesn't exist"
          
          TG_ARN=$(aws elbv2 describe-target-groups --names protein-classifier-ecs-tg --query 'TargetGroups[0].TargetGroupArn' --output text 2>/dev/null || echo "none")
          if [ "$TG_ARN" != "none" ] && [ "$TG_ARN" != "" ]; then
            terraform import aws_lb_target_group.ecs "$TG_ARN" 2>/dev/null || echo "Target group: already in state or doesn't exist"
          fi
          
          terraform import aws_dynamodb_table.terraform_locks protein-classifier-terraform-locks 2>/dev/null || echo "DynamoDB: already in state or doesn't exist"
          terraform import aws_ecr_repository.api protein-classifier-api 2>/dev/null || echo "ECR: already in state or doesn't exist"
          terraform import aws_cloudwatch_log_group.ecs_logs /ecs/protein-classifier-api 2>/dev/null || echo "CW logs (ECS): already in state or doesn't exist"
          terraform import aws_cloudwatch_log_group.vpc_flow_logs /aws/vpc/protein-classifier-flow-logs 2>/dev/null || echo "CW logs (VPC): already in state or doesn't exist"
          terraform import aws_iam_role.github_actions protein-classifier-github-actions-role 2>/dev/null || echo "IAM (github): already in state or doesn't exist"
          terraform import aws_iam_role.ecs_task_execution_role protein-classifier-ecs-task-execution-role 2>/dev/null || echo "IAM (exec): already in state or doesn't exist"
          terraform import aws_iam_role.ecs_task_role protein-classifier-ecs-task-role 2>/dev/null || echo "IAM (task): already in state or doesn't exist"
          terraform import aws_iam_role.vpc_flow_logs protein-classifier-vpc-flow-logs-role 2>/dev/null || echo "IAM (vpc): already in state or doesn't exist"
          
          echo "âœ… Import step complete"

      - name: Terraform Apply
        id: apply
        run: |
          cd terraform
          echo "ðŸš€ Applying Terraform changes..."
          terraform apply -auto-approve -no-color tfplan.out
          echo "âœ… Terraform apply completed successfully!"

      - name: Output Infrastructure Details
        if: success()
        run: |
          cd terraform
          echo "## ðŸŽ‰ Infrastructure Deployment Successful!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
