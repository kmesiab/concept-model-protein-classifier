name: Terraform Apply

on:
  workflow_dispatch:
    inputs:
      confirm:
        description: 'Type "apply" to confirm infrastructure changes'
        required: true
        type: string
      plan_run_id:
        description: 'Optional: Workflow run ID containing cached Terraform plan'
        required: false
        type: string
        default: ''

# Prevent concurrent Terraform runs to avoid state lock conflicts
concurrency:
  group: terraform-apply
  cancel-in-progress: false

permissions:
  contents: read
  id-token: write
  pull-requests: write

jobs:
  validate:
    name: Pre-Apply Validation (Triple-Gated)
    runs-on: ubuntu-latest

    steps:
      - name: Verify Confirmation
        run: |
          if [ "${{ inputs.confirm }}" != "apply" ]; then
            echo "âŒ Confirmation failed. You must type 'apply' to proceed."
            exit 1
          fi
          echo "âœ… Confirmation received. Proceeding with validation..."

      - name: Checkout code
        uses: actions/checkout@v6

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ vars.AWS_ACCOUNT_ID }}:role/github-actions-terraform
          aws-region: ${{ vars.TF_STATE_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.0

      - name: Setup TFLint
        uses: terraform-linters/setup-tflint@v4
        with:
          tflint_version: latest

      - name: Terraform Init
        env:
          TF_STATE_BUCKET: ${{ vars.TF_STATE_BUCKET }}
          TF_STATE_KEY: ${{ vars.TF_STATE_KEY }}
          TF_STATE_REGION: ${{ vars.TF_STATE_REGION }}
          TF_STATE_DYNAMODB_TABLE: ${{ vars.TF_STATE_DYNAMODB_TABLE }}
        run: |
          terraform -chdir=terraform init \
            -backend-config="bucket=${TF_STATE_BUCKET}" \
            -backend-config="key=${TF_STATE_KEY}" \
            -backend-config="region=${TF_STATE_REGION}" \
            -backend-config="dynamodb_table=${TF_STATE_DYNAMODB_TABLE}"

      # Gate 1: TFLint
      - name: Gate 1 - TFLint Validation
        run: |
          cd terraform
          tflint --init
          echo "ðŸ” Running TFLint validation..."
          tflint --format compact --minimum-failure-severity=error
          echo "âœ… Gate 1 (TFLint) PASSED"

      # Gate 2: Trivy Terraform Security Scan
      - name: Gate 2 - Trivy Terraform Scan
        id: trivy
        uses: aquasecurity/trivy-action@0.33.1
        with:
          scan-type: 'config'
          scan-ref: 'terraform'
          format: 'json'
          output: 'trivy-terraform.json'
          exit-code: '0'  # Don't fail the action itself, we'll parse results

      - name: Gate 2 Status
        if: always()
        run: |
          echo "### ðŸ”’ Gate 2: Trivy Terraform Security Scan Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          REPORT=trivy-terraform.json
          if [ -f "$REPORT" ]; then
            TOTAL=$(jq -r '(.Results // []) | map(.Misconfigurations // []) | flatten | length' "$REPORT")
            # Count findings by severity level
            CRITICAL=$(jq -r '(.Results // []) | map(.Misconfigurations // []) | flatten | map(select(.Severity=="CRITICAL")) | length' "$REPORT")
            HIGH=$(jq -r '(.Results // []) | map(.Misconfigurations // []) | flatten | map(select(.Severity=="HIGH")) | length' "$REPORT")
            MEDIUM=$(jq -r '(.Results // []) | map(.Misconfigurations // []) | flatten | map(select(.Severity=="MEDIUM")) | length' "$REPORT")
            LOW=$(jq -r '(.Results // []) | map(.Misconfigurations // []) | flatten | map(select(.Severity=="LOW")) | length' "$REPORT")

            echo "- Findings: $TOTAL" >> $GITHUB_STEP_SUMMARY
            echo "  - CRITICAL: $CRITICAL" >> $GITHUB_STEP_SUMMARY
            echo "  - HIGH:     $HIGH" >> $GITHUB_STEP_SUMMARY
            echo "  - MEDIUM:   $MEDIUM" >> $GITHUB_STEP_SUMMARY
            echo "  - LOW:      $LOW" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            # Validate TOTAL is a number before comparison
            if [[ "$TOTAL" =~ ^[0-9]+$ ]]; then
              if [ "$TOTAL" -gt 0 ]; then
                echo "âŒ Security issues detected"
                echo "**Security findings must be addressed before applying infrastructure changes.**"
                echo ""
                echo "Security findings breakdown:"
                echo "  - CRITICAL: $CRITICAL"
                echo "  - HIGH: $HIGH"
                echo "  - MEDIUM: $MEDIUM"
                echo "  - LOW: $LOW"
                echo ""
                echo "Running Trivy with detailed output:"
                echo ""
                docker run --rm -v "${GITHUB_WORKSPACE:-$PWD}:/src" aquasec/trivy:latest config /src/terraform
                echo ""
                echo "âŒ Gate 2 (Trivy) FAILED"
                echo "âŒ Security issues detected" >> $GITHUB_STEP_SUMMARY
                echo "**Security findings must be addressed before applying infrastructure changes.**" >> $GITHUB_STEP_SUMMARY
                echo "âŒ Gate 2 (Trivy) FAILED" >> $GITHUB_STEP_SUMMARY
                exit 1
              else
                echo "âœ… No security issues found"
                echo "âœ… Gate 2 (Trivy) PASSED"
                echo "âœ… No security issues found" >> $GITHUB_STEP_SUMMARY
                echo "âœ… Gate 2 (Trivy) PASSED" >> $GITHUB_STEP_SUMMARY
              fi
            else
              echo "âš ï¸ Unable to parse Trivy findings count from report (TOTAL=\"$TOTAL\")."
              echo "âŒ Gate 2 (Trivy) FAILED"
              echo "âš ï¸ Unable to parse Trivy findings count from report (TOTAL=\"$TOTAL\")." >> $GITHUB_STEP_SUMMARY
              echo "âŒ Gate 2 (Trivy) FAILED" >> $GITHUB_STEP_SUMMARY
              exit 1
            fi
          else
            # Report file is missing - this is an error condition
            echo "âŒ Trivy report file not found"
            echo "âŒ Gate 2 (Trivy) FAILED"
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âŒ Trivy report file not found - cannot verify security posture" >> $GITHUB_STEP_SUMMARY
            echo "âŒ Gate 2 (Trivy) FAILED" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

      # Gate 3: Cost Estimation
      - name: Setup Infracost
        uses: infracost/actions/setup@v3
        with:
          api-key: ${{ secrets.INFRACOST_API_KEY }}

      - name: Gate 3 - Cost Estimation
        continue-on-error: true # Skip cost estimation gate for now
        run: |
          cd terraform
          echo "ðŸ’° Generating cost estimate..."
          infracost breakdown --path . \
            --terraform-var="aws_account_id=${{ vars.AWS_ACCOUNT_ID || '000000000000' }}" \
            --format json \
            --out-file /tmp/infracost.json
          
          # Extract total monthly cost
          TOTAL_COST=$(jq -r '.totalMonthlyCost' /tmp/infracost.json)
          THRESHOLD=125
          
          echo "ðŸ“Š Total Monthly Cost: \$$TOTAL_COST"
          echo "ðŸŽ¯ Cost Threshold: \$$THRESHOLD"
          
          # Compare costs (using bc for decimal comparison)
          if [ $(echo "$TOTAL_COST > $THRESHOLD" | bc -l) -eq 1 ]; then
            echo "âŒ COST THRESHOLD EXCEEDED!"
            echo "   Estimated: \$$TOTAL_COST/month"
            echo "   Threshold: \$$THRESHOLD/month"
            echo "   Overage: \$$(echo "$TOTAL_COST - $THRESHOLD" | bc -l)/month"
            exit 1
          fi
          
          echo "âœ… Gate 3 (Cost Estimation) PASSED - Under threshold"

  terraform-apply:
    name: Apply Terraform Changes
    runs-on: ubuntu-latest
    needs: validate
    environment:
      name: production
      url: https://api.proteinclassifier.com

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ vars.AWS_ACCOUNT_ID }}:role/github-actions-terraform
          aws-region: ${{ vars.TF_STATE_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.0

      - name: Terraform Validate
        run: terraform -chdir=terraform validate

      - name: Download Cached Terraform Plan
        if: inputs.plan_run_id != ''
        uses: actions/download-artifact@v4
        with:
          name: terraform-plan
          run-id: ${{ inputs.plan_run_id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
          path: terraform

      - name: Terraform Plan
        if: inputs.plan_run_id == ''
        id: plan
        run: |
          cd terraform
          terraform plan \
            -var="aws_account_id=${{ vars.AWS_ACCOUNT_ID || '000000000000' }}" \
            -out=tfplan.out \
            -no-color
          
          # Show the plan
          terraform show -no-color tfplan.out

      - name: Upload Terraform Plan Artifact
        if: inputs.plan_run_id == ''
        uses: actions/upload-artifact@v4
        with:
          name: terraform-plan
          path: terraform/tfplan.out
          retention-days: 7

      - name: Terraform Apply
        id: apply
        run: |
          cd terraform
          echo "ðŸš€ Applying Terraform changes..."
          terraform apply -auto-approve -no-color tfplan.out
          echo "âœ… Terraform apply completed successfully!"

      - name: Output Infrastructure Details
        if: success()
        run: |
          cd terraform
          echo "## ðŸŽ‰ Infrastructure Deployment Successful!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
