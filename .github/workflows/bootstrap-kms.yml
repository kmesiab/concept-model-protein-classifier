name: Bootstrap KMS Permissions

# This is a one-time workflow to fix the chicken-and-egg problem with KMS permissions.
# 
# Problem:
# - Terraform code has KMS permissions for GitHub Actions role
# - Terraform can't apply them because it needs those permissions to access DynamoDB state lock
# 
# Solution:
# - This workflow directly updates the KMS key policy using AWS CLI
# - After running this once, regular Terraform Apply workflow should work
#
# Usage:
# 1. Go to Actions > Bootstrap KMS Permissions
# 2. Click "Run workflow"
# 3. Type "bootstrap" to confirm
# 4. After success, run the regular Terraform Apply workflow

on:
  workflow_dispatch:
    inputs:
      confirm:
        description: 'Type "bootstrap" to confirm this one-time operation'
        required: true
        type: string

permissions:
  contents: read
  id-token: write

jobs:
  bootstrap:
    name: Bootstrap KMS Permissions
    runs-on: ubuntu-latest
    
    steps:
      - name: Verify Confirmation
        run: |
          if [ "${{ inputs.confirm }}" != "bootstrap" ]; then
            echo "âŒ Confirmation failed. You must type 'bootstrap' to proceed."
            exit 1
          fi
          echo "âœ… Confirmation received. Proceeding with bootstrap..."

      - name: Checkout code
        uses: actions/checkout@v6

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          # Note: Using a different role with broader permissions for this bootstrap
          # The github-actions-terraform role doesn't have KMS PutKeyPolicy permission yet
          role-to-assume: arn:aws:iam::${{ vars.AWS_ACCOUNT_ID }}:role/github-actions-terraform-admin
          aws-region: ${{ vars.TF_STATE_REGION }}
          role-session-name: GitHubActionsBootstrap

      - name: Install jq
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      - name: Validate AWS Access
        run: |
          echo "ðŸ” Validating AWS credentials..."
          aws sts get-caller-identity
          echo "âœ… AWS credentials validated"

      - name: Run Bootstrap Script
        env:
          KMS_KEY_ID: e9b37450-f4df-45d6-a336-aefd3b1d0896
          GITHUB_ACTIONS_ROLE_ARN: arn:aws:iam::${{ vars.AWS_ACCOUNT_ID }}:role/github-actions-terraform
          AWS_REGION: ${{ vars.TF_STATE_REGION }}
          AWS_ACCOUNT_ID: ${{ vars.AWS_ACCOUNT_ID }}
          CI: true
        run: |
          cd terraform
          ./bootstrap-kms-permissions.sh

      - name: Verify Bootstrap Success
        env:
          KMS_KEY_ID: e9b37450-f4df-45d6-a336-aefd3b1d0896
          GITHUB_ACTIONS_ROLE_ARN: arn:aws:iam::${{ vars.AWS_ACCOUNT_ID }}:role/github-actions-terraform
          AWS_REGION: ${{ vars.TF_STATE_REGION }}
        run: |
          echo "ðŸ” Verifying GitHub Actions role has KMS permissions..."
          
          # Get the updated policy
          POLICY=$(aws kms get-key-policy \
            --key-id "$KMS_KEY_ID" \
            --policy-name default \
            --region "$AWS_REGION" \
            --query 'Policy' \
            --output text)
          
          # Check for required permissions
          if echo "$POLICY" | jq -e ".Statement[] | select(.Principal.AWS == \"$GITHUB_ACTIONS_ROLE_ARN\")" > /dev/null; then
            echo "âœ… GitHub Actions role found in KMS policy"
            
            ACTIONS=$(echo "$POLICY" | jq -r ".Statement[] | select(.Principal.AWS == \"$GITHUB_ACTIONS_ROLE_ARN\") | .Action | if type == \"array\" then .[] else . end")
            
            echo "ðŸ“‹ Granted permissions:"
            echo "$ACTIONS" | sed 's/^/   - /'
            
            # Verify required permissions
            for action in "kms:Decrypt" "kms:DescribeKey" "kms:GenerateDataKey"; do
              if echo "$ACTIONS" | grep -q "$action"; then
                echo "   âœ… $action present"
              else
                echo "   âŒ $action MISSING"
                exit 1
              fi
            done
            
            echo ""
            echo "âœ… All required KMS permissions verified!"
            echo ""
            echo "ðŸŽ‰ Bootstrap successful!"
            echo "   You can now run the Terraform Apply workflow"
          else
            echo "âŒ GitHub Actions role not found in KMS policy"
            exit 1
          fi

      - name: Next Steps
        if: success()
        run: |
          echo "## ðŸŽ‰ Bootstrap Successful!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The GitHub Actions role now has KMS permissions to access the DynamoDB state lock table." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Next Steps:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "1. âœ… Go to **Actions** > **Terraform Apply**" >> $GITHUB_STEP_SUMMARY
          echo "2. âœ… Click **Run workflow**" >> $GITHUB_STEP_SUMMARY
          echo "3. âœ… Type **apply** to confirm" >> $GITHUB_STEP_SUMMARY
          echo "4. âœ… The workflow should now complete successfully!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### What Changed:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "This workflow updated the KMS key policy to grant the following permissions:" >> $GITHUB_STEP_SUMMARY
          echo "- \`kms:Decrypt\` - Required to decrypt DynamoDB items" >> $GITHUB_STEP_SUMMARY
          echo "- \`kms:DescribeKey\` - Required to get key metadata" >> $GITHUB_STEP_SUMMARY
          echo "- \`kms:GenerateDataKey\` - Required to generate data encryption keys" >> $GITHUB_STEP_SUMMARY
          echo "- \`kms:Encrypt\` - Required to encrypt DynamoDB items" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Note:** This workflow only needs to be run once. Future Terraform updates will manage the KMS policy." >> $GITHUB_STEP_SUMMARY
